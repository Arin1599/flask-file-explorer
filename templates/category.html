{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.css">
<style>
  .controls {
    display:flex;
    gap:8px;
    align-items:center;
    margin-bottom:12px;
  }
  .controls .btn { min-width: 120px; }
  #catGrid { margin: 0 auto; }
  .masonry-item {
    width: 160px;
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding-bottom: 8px;
  }
  .masonry-item.hidden { display: none !important; }
  .thumb.lazy-thumb {
    width: 144px;
    height: 144px;
    object-fit: cover;
    border-radius: 6px;
    margin-top: 8px;
    background: #f3f3f3;
    display: block;
  }
  .file-name { font-size:12px; word-break:break-word; text-align:center; padding:4px 8px; max-width:150px; }
  .btn.active { background-color:#0d6efd; color:#fff; border-color:#0d6efd; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">‚Üê Home</a>
  </div>
  <div class="controls">
    <div class="btn-group" role="group" aria-label="Sort">
      {% set curr_sort = request.args.get('sort', 'orig_time') %}
      {% set curr_order = request.args.get('order', 'desc') %}
      <a href="{{ url_for('view_category', cat=cat, sort='orig_time', order=curr_order) }}" class="btn btn-sm btn-outline-primary {% if curr_sort=='orig_time' %}active{% endif %}">Sort: Original Date</a>
      <a href="{{ url_for('view_category', cat=cat, sort='mtime', order=curr_order) }}" class="btn btn-sm btn-outline-primary {% if curr_sort=='mtime' %}active{% endif %}">Sort: File MTime</a>
    </div>
    <div class="btn-group ms-2" role="group" aria-label="Order">
      <a href="{{ url_for('view_category', cat=cat, sort=curr_sort, order='desc') }}" class="btn btn-sm btn-outline-secondary {% if curr_order!='asc' %}active{% endif %}">Desc</a>
      <a href="{{ url_for('view_category', cat=cat, sort=curr_sort, order='asc') }}" class="btn btn-sm btn-outline-secondary {% if curr_order=='asc' %}active{% endif %}">Asc</a>
    </div>
  </div>
</div>

<h4 class="mb-2">Category: {{ cat|capitalize }} ({{ files|length }})</h4>

<div id="catGrid" class="row" data-masonry='{"itemSelector": ".masonry-item", "columnWidth": 160, "gutter": 16 }'>
  {% for f in files %}
    <div class="masonry-item col" data-path="{{ f.path }}" data-type="{{ f.category }}">
      <a href="{{ url_for('view_file') }}?path={{ f.path }}">
        {% if f.thumbnail %}
          <img class="thumb lazy-thumb" data-src="{{ url_for('thumbnail', thumb_rel=f.thumbnail) }}" alt="{{ f.name|default(f.rel_path) }}" loading="lazy">
        {% else %}
          <img class="thumb lazy-thumb" data-src="https://via.placeholder.com/150?text={{ f.ext|urlencode }}" alt="{{ f.name|default(f.rel_path) }}" loading="lazy">
        {% endif %}
      </a>

      {% if f.category == 'video' %}
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('view_file') }}?path={{ f.path }}" download title="Save video">
            Download
          </a>
          <div class="file-name">{{ f.name }}</div>
        </div>
      {% else %}
        <div class="file-name">{{ f.name }}</div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const catGrid = document.getElementById('catGrid');
  // initialize masonry
  catGrid.masonry = new Masonry(catGrid, {
    itemSelector: '.masonry-item',
    columnWidth: 160,
    gutter: 16,
    percentPosition: true
  });

  // Lazy load thumbnails with IntersectionObserver
  const lazyThumbs = document.querySelectorAll('.lazy-thumb');
  if ('IntersectionObserver' in window) {
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
          }
          obs.unobserve(img);
        }
      });
    }, { rootMargin: '200px', threshold: 0.01 });
    lazyThumbs.forEach(img => observer.observe(img));
  } else {
    // fallback
    lazyThumbs.forEach(img => {
      if (img.dataset.src) {
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
      }
    });
  }

  // ensure layout after lazy loads (some images set src later)
  let updateCount = 0;
  function relayoutDeferred() {
    updateCount++;
    setTimeout(() => {
      if (catGrid.masonry) catGrid.masonry.layout();
      updateCount = Math.max(0, updateCount-1);
    }, 120);
  }
  // observe image load to relayout
  document.querySelectorAll('.masonry-item img').forEach(img => {
    img.addEventListener('load', relayoutDeferred);
  });

  // initial layout
  setTimeout(() => { if (catGrid.masonry) catGrid.masonry.layout(); }, 100);
});
</script>
{% endblock %}
