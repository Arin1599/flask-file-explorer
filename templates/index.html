{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.css">
<style>
  .sticky-filters {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #fff;
    padding: 12px 0 8px 0;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  #masonryGrid {
    margin: 0 auto;
  }
  .masonry-item {
    width: 160px;
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding-bottom: 8px;
  }
.masonry-item.hidden {
  display: none !important;
}

  .thumb.lazy-thumb {
    width: 144px;
    height: 144px;
    object-fit: cover;
    border-radius: 6px;
    margin-top: 8px;
    background: #f3f3f3;
    display: block;
  }
</style>

<div class="sticky-filters d-flex justify-content-center gap-3">
  <button class="btn btn-outline-primary" id="filterAll">All</button>
  <button class="btn btn-outline-primary" id="filterPhotos">Photos</button>
  <button class="btn btn-outline-primary" id="filterVideos">Videos</button>
</div>

<div id="masonryGrid" class="row" data-masonry='{"itemSelector": ".masonry-item", "columnWidth": 160, "gutter": 16 }'>
  {% for f in all_files %}
    <div class="masonry-item col" data-type="{{ f.type }}">
      <a href="{{ url_for('view_file') }}?path={{ f.path }}">
          {% if f.thumbnail %}
            <img class="thumb lazy-thumb" data-src="{{ url_for('thumbnail', thumb_rel=f.thumbnail) }}" alt="Thumbnail" loading="lazy">
          {% else %}
            <img class="thumb lazy-thumb" data-src="https://via.placeholder.com/150?text={{ f.ext }}" alt="Thumbnail" loading="lazy">
          {% endif %}
      </a>
      {% if f.type == 'video' %}
        <div style="margin-top:4px;">
          <a href="{{ url_for('view_file') }}?path={{ f.path }}" download title="Save video">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5V13a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2.6a.5.5 0 0 1 1 0V13a3 3 0 0 1-3 3H3a3 3 0 0 1-3-3v-2.6a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
          </a>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script>
const filterAll = document.getElementById('filterAll');
const filterPhotos = document.getElementById('filterPhotos');
const filterVideos = document.getElementById('filterVideos');
const masonryGrid = document.getElementById('masonryGrid');

function setActive(btn) {
  [filterAll, filterPhotos, filterVideos].forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function filter(type) {
  let changed = false;
  for (const item of masonryGrid.querySelectorAll('.masonry-item')) {
    if (type === 'all' || item.dataset.type === type) {
      if (item.classList.contains('hidden')) {
        item.classList.remove('hidden');
        changed = true;
      }
    } else {
      if (!item.classList.contains('hidden')) {
        item.classList.add('hidden');
        changed = true;
      }
    }
  }
  // Only re-layout Masonry if something changed
  if (changed && window.Masonry && masonryGrid.masonry) {
    masonryGrid.masonry.layout();
  }
}

filterAll.onclick = () => { setActive(filterAll); filter('all'); };
filterPhotos.onclick = () => { setActive(filterPhotos); filter('images'); };
filterVideos.onclick = () => { setActive(filterVideos); filter('video'); };

// Default to All
setActive(filterAll);
filter('all');

// Initialize Masonry
document.addEventListener('DOMContentLoaded', function() {
  masonryGrid.masonry = new Masonry(masonryGrid, {
    itemSelector: '.masonry-item',
    columnWidth: 160,
    gutter: 16,
    percentPosition: true
  });

  // Lazy load thumbnails using Intersection Observer
  const lazyThumbs = document.querySelectorAll('.lazy-thumb');
  if ('IntersectionObserver' in window) {
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
          }
          obs.unobserve(img);
        }
      });
    }, {
      rootMargin: '100px',
      threshold: 0.01
    });
    lazyThumbs.forEach(img => observer.observe(img));
  } else {
    // Fallback for browsers without Intersection Observer
    lazyThumbs.forEach(img => {
      if (img.dataset.src) {
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
      }
    });
  }
});
</script>
{% endblock %}
