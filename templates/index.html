{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.css">
<style>
  .sticky-filters {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #fff;
    padding: 12px 0 8px 0;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  #masonryGrid { margin: 0 auto; }
  .masonry-item {
    width: 160px;
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding-bottom: 8px;
  }
  .masonry-item.hidden { display: none !important; }
  .thumb.lazy-thumb {
    width: 144px;
    height: 144px;
    object-fit: cover;
    border-radius: 6px;
    margin-top: 8px;
    background: #f3f3f3;
    display: block;
  }
  .btn.active { background-color:#0d6efd; color:#fff; border-color:#0d6efd; }
  /* small debug badge */
  #filterDebug {
    position: fixed;
    right: 12px;
    top: 80px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    z-index: 9999;
    display: none;
  }
</style>

<div class="sticky-filters d-flex justify-content-center gap-3">
  <button class="btn btn-outline-primary" id="filterAll" type="button">All</button>
  <button class="btn btn-outline-primary" id="filterPhotos" type="button">Photos</button>
  <button class="btn btn-outline-primary" id="filterVideos" type="button">Videos</button>
</div>

<div id="masonryGrid" class="row" data-masonry='{"itemSelector": ".masonry-item", "columnWidth": 160, "gutter": 16 }'>
  {% for f in all_files %}
    <div class="masonry-item col" data-type="{{ f.type }}" data-path="{{ f.path }}">
      <a href="{{ url_for('view_file') }}?path={{ f.path }}">
          {% if f.thumbnail %}
            <img class="thumb lazy-thumb" data-src="{{ url_for('thumbnail', thumb_rel=f.thumbnail) }}" alt="Thumbnail" loading="lazy">
          {% else %}
            <img class="thumb lazy-thumb" data-src="https://via.placeholder.com/150?text={{ f.ext }}" alt="Thumbnail" loading="lazy">
          {% endif %}
      </a>
      {% if f.type == 'video' %}
        <div style="margin-top:4px;">
          <a href="{{ url_for('view_file') }}?path={{ f.path }}" download title="Save video">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5V13a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2.6a.5.5 0 0 1 1 0V13a3 3 0 0 1-3 3H3a3 3 0 0 1-3-3v-2.6a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
          </a>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<div id="filterDebug"></div>

<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const btnAll = document.getElementById('filterAll');
  const btnPhotos = document.getElementById('filterPhotos');
  const btnVideos = document.getElementById('filterVideos');
  const masonryGrid = document.getElementById('masonryGrid');
  const debug = document.getElementById('filterDebug');

  if (!masonryGrid) {
    console.error('masonryGrid element not found!');
    return;
  }

  // Initialize Masonry
  let masonryInstance = null;
  try {
    masonryInstance = new Masonry(masonryGrid, {
      itemSelector: '.masonry-item',
      columnWidth: 160,
      gutter: 16,
      percentPosition: true
    });
    // attach for other code to check
    masonryGrid.masonry = masonryInstance;
  } catch (e) {
    console.warn('Masonry init failed or not loaded:', e);
  }

  // Normalize type strings to 'images' or 'video' or 'other'
  function normalizeType(raw) {
    if (!raw) return 'other';
    raw = raw.toString().toLowerCase().trim();
    // common variants
    if (raw === 'image' || raw === 'images' || raw.startsWith('image')) return 'images';
    if (raw === 'photo' || raw === 'photos') return 'images';
    if (raw === 'video' || raw === 'videos' || raw.startsWith('video')) return 'video';
    return raw;
  }

  function countVisible() {
    const items = masonryGrid.querySelectorAll('.masonry-item');
    let total = items.length, visible = 0;
    items.forEach(it => { if (!it.classList.contains('hidden')) visible++; });
    return { total, visible };
  }

  // show debug badge briefly
  function showDebug(msg, timeout=1200) {
    debug.style.display = 'block';
    debug.textContent = msg;
    setTimeout(()=>{ debug.style.display = 'none'; }, timeout);
  }

  // Filtering logic
  function doFilter(type) {
    const items = masonryGrid.querySelectorAll('.masonry-item');
    let changed = false;
    items.forEach(item => {
      const dtRaw = item.dataset.type || item.getAttribute('data-type') || '';
      const itype = normalizeType(dtRaw);
      const shouldShow = (type === 'all') || (itype === type);
      if (shouldShow) {
        if (item.classList.contains('hidden')) {
          item.classList.remove('hidden');
          changed = true;
        }
      } else {
        if (!item.classList.contains('hidden')) {
          item.classList.add('hidden');
          changed = true;
        }
      }
    });

    // Force Masonry relayout if present
    if (masonryGrid.masonry) {
      // small delay to let DOM changes settle
      setTimeout(()=>{ masonryGrid.masonry.layout(); }, 60);
    }

    const c = countVisible();
    console.debug(`[filter] type=${type} changed=${changed} visible=${c.visible}/${c.total}`);
    showDebug(`${c.visible}/${c.total}`);
    return changed;
  }

  // attach handlers
  if (btnAll) btnAll.addEventListener('click', ()=>{ setActive(btnAll); doFilter('all'); });
  if (btnPhotos) btnPhotos.addEventListener('click', ()=>{ setActive(btnPhotos); doFilter('images'); });
  if (btnVideos) btnVideos.addEventListener('click', ()=>{ setActive(btnVideos); doFilter('video'); });

  function setActive(btn) {
    [btnAll, btnPhotos, btnVideos].forEach(b => { if (b) b.classList.remove('active'); });
    if (btn) btn.classList.add('active');
  }

  // Default state
  setActive(btnAll);
  // initially ensure none hidden before layout
  doFilter('all');

  // Lazy load thumbnails (IntersectionObserver)
  const lazyThumbs = masonryGrid.querySelectorAll('.lazy-thumb');
  if ('IntersectionObserver' in window) {
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
          }
          obs.unobserve(img);
        }
      });
    }, { rootMargin: '200px', threshold: 0.01 });
    lazyThumbs.forEach(img => observer.observe(img));
  } else {
    lazyThumbs.forEach(img => { if (img.dataset.src) { img.src = img.dataset.src; img.removeAttribute('data-src'); } });
  }

  // ensure layout when images load
  masonryGrid.querySelectorAll('.masonry-item img').forEach(img => {
    img.addEventListener('load', () => { if (masonryGrid.masonry) masonryGrid.masonry.layout(); });
  });

  // debug: print initial dataset-types (helps spot mismatches)
  const typeCounts = {};
  masonryGrid.querySelectorAll('.masonry-item').forEach(it => {
    const t = normalizeType(it.dataset.type || it.getAttribute('data-type') || '');
    typeCounts[t] = (typeCounts[t] || 0) + 1;
  });
  console.info('Initial item type counts:', typeCounts);
});
</script>
{% endblock %}
